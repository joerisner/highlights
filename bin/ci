#!/usr/bin/env bash

# Local CI checks.
# This is executed as a pre-push git hook, but can be ran ad-hoc as well: `bin/ci`.

GREEN='\033[32;1m'
RED='\033[31;1m'
BLUE='\033[34;1m'
DIM_WHITE='\033[37;2m'
RESET='\033[0m'

FAILURES=0

run_check() {
    local desc=$1
    local cmd=$2
    
    eval "$cmd" &>/dev/null

    # shellcheck disable=SC2181
    if [[ $? -eq 0 ]]; then
        printf "${GREEN}âœ”${RESET} %s\n" "$desc"
    else
        printf "${RED}âœ˜${RESET} %s\n" "$desc"
        printf "  ${DIM_WHITE}â†³ hint: run \`%s\` to troubleshoot${RESET}\n" "$cmd"
        FAILURES=$((FAILURES + 1))
    fi
}

printf "âˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆž\n"
# shellcheck disable=SC2059
printf "âˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆž ${BLUE}CI${RESET} âˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆž\n"
printf "âˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆž\n\n"

run_check "lint" "uv run ruff check ."
run_check "format" "uv run ruff format --check"
run_check "typecheck" "uv run ty check"
run_check "test" "make test"

if [[ $FAILURES -gt 0 ]]; then
    # shellcheck disable=SC2059
    printf "\nðŸš« CI ${RED}failed${RESET}\n"
    printf "âˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆž\n\n"
    exit 1
fi
# shellcheck disable=SC2059
printf "\nðŸš€ CI ${GREEN}passed${RESET}\n"
printf "âˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆžâˆž\n\n"
